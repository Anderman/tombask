#include <Arduino.h>
#include "rs485_25_6.h"
#include <cstdint>
#include "rs485.h"
#include "sensors.h"
struct __attribute__((packed)) Frame25_6
{
    uint8_t start1;          // 7E 7E F0 F0 03 25 90 31 06 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t start2;          // 7E F0 F0 03 25 90 31 06 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t dst;             // F0 F0 03 25 90 31 06 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t src;             // F0 03 25 90 31 06 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t type;            // 03 25 90 31 06 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t lengte;          // 25 90 31 06 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint16_t protocol;       // 90 31 06 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t func;            // 06 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a9;              // 55 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a10;             // 3c 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a11;             // 01 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a12;             // 14 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a13;             // 14 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a14;             // 00 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a15;             // 00 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a16;             // 00 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a17;             // 55 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a18;             // 3c 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a19;             // 01 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a20;             // 00 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t suctionPressure; // 14 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a22;             // 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a23;             // 00 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a24;             // 00 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a25;             // 00 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a26;             // 00 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a27;             // 00 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a28;             // 00 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a29;             // 06 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a30;             // 00 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a31;             // 00 00 00 00 00 00 00 00 00 00 09
    uint8_t a32;             // 00 00 00 00 00 00 00 00 00 09
    uint8_t a33;             // 00 00 00 00 00 00 00 00 09
    uint8_t a34;             // 00 00 00 00 00 00 00 09
    uint8_t a35;             // 00 00 00 00 00 00 09
    uint8_t a36;             // 00 00 00 00 00 09
    uint8_t a37;             // 00 00 00 00 09
    uint8_t a38;             // 00 00 00 09
    uint8_t a39;             // 00 00 09
    uint8_t a40;             // 00 09
    uint8_t a41;             // 09
};

static float extract_P4(const uint8_t *b) { return b[38] * 256 + b[39]; }
#define EXTRACT_BYTE(idx) [](const uint8_t *b) -> float { return b[idx]; }

static const SensorField2 sensorMap[] = {
    {"25_6_9", "fan speed 1_target", "", "", EXTRACT_BYTE(9)},
    {"25_6_10", "fan speed 1", "", "", EXTRACT_BYTE(10)},
    {"25_6_11", "fan speed 1_onOff", "", "", EXTRACT_BYTE(11)},
    {"25_6_12", "25_6[12]", "", "", EXTRACT_BYTE(12)},
    {"25_6_13", "25_6[13]", "", "", EXTRACT_BYTE(13)},
    {"25_6_14", "25_6[14]", "", "", EXTRACT_BYTE(14)},
    {"25_6_15", "25_6[15]", "", "", EXTRACT_BYTE(15)},
    {"25_6_16", "25_6[16]", "", "", EXTRACT_BYTE(16)},
    {"25_6_17", "fan speed 2_target", "", "", EXTRACT_BYTE(17)},
    {"25_6_18", "fan speed 2", "", "", EXTRACT_BYTE(18)},
    {"25_6_19", "fan speed 2_onOff", "", "", EXTRACT_BYTE(19)},
    {"25_6_20", "25_6[20]", "", "", EXTRACT_BYTE(20)},
    {"25_6_21", "fan related 1", "", "", EXTRACT_BYTE(21), 1},
    {"25_6_22", "25_6[22]", "", "", EXTRACT_BYTE(22)},
    {"25_6_23", "25_6[23]", "", "", EXTRACT_BYTE(23)},
    {"25_6_24", "25_6[24]", "", "", EXTRACT_BYTE(24)},
    {"25_6_25", "25_6[25]", "", "", EXTRACT_BYTE(25)},
    {"25_6_26", "25_6[26]", "", "", EXTRACT_BYTE(26)},
    {"25_6_27", "25_6[27]", "", "", EXTRACT_BYTE(27)},
    {"25_6_28", "25_6[28]", "", "", EXTRACT_BYTE(28)},
    {"25_6_29", "25_6[29] state 2", "", "", EXTRACT_BYTE(29)},
    {"25_6_30", "25_6[30]", "", "", EXTRACT_BYTE(30)},
    {"25_6_31", "25_6[31]", "", "", EXTRACT_BYTE(31)},
    {"25_6_32", "25_6[32]", "", "", EXTRACT_BYTE(32)},
    {"25_6_33", "25_6[33]", "", "", EXTRACT_BYTE(33)},
    {"25_6_34", "25_6[34]", "", "", EXTRACT_BYTE(34)},
    {"25_6_35", "25_6[35]", "", "", EXTRACT_BYTE(35)},
    {"25_6_36", "25_6[36]", "", "", EXTRACT_BYTE(36)},
    {"25_6_37", "25_6[37]", "", "", EXTRACT_BYTE(37)},
    {"25_6_38", "25_6[38]", "", "", EXTRACT_BYTE(38)},
    {"25_6_39", "25_6[39]", "", "", EXTRACT_BYTE(39)},
    {"25_6_40", "25_6[40]", "", "", EXTRACT_BYTE(40)},
    {"25_6_41", "25_6[41]", "", "", EXTRACT_BYTE(41)},
};

void read_25_6(const uint8_t *buffer)
{
    static const int length = sizeof(sensorMap) / sizeof(sensorMap[0]);
    static float lastValues[length] = {0};
    static bool discoveryPublished[length] = {0};

    publishSensors(sensorMap, buffer, lastValues, discoveryPublished, length);
}